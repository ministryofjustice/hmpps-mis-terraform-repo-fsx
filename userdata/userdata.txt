<powershell>
$misCreds = New-Credential -UserName "${user}" -Password "${password}"
Install-User -Credential $misCreds
Add-GroupMember -Name Administrators -Member ${user}

$bossoCreds = New-Credential -UserName "${bosso_user}" -Password "${bosso_password}"
Install-User -Credential $bossoCreds
Add-GroupMember -Name Administrators -Member ${bosso_user}

$ComputerName = "${host_name}"

Remove-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" -name "Hostname"
Remove-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" -name "NV Hostname"

New-PSDrive -name HKU -PSProvider "Registry" -Root "HKEY_USERS"

Set-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\Computername\Computername" -name "Computername" -value $ComputerName
Set-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\Computername\ActiveComputername" -name "Computername" -value $ComputerName
Set-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" -name "Hostname" -value $ComputerName
Set-ItemProperty -path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" -name "NV Hostname" -value  $ComputerName
Set-ItemProperty -path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" -name "AltDefaultDomainName" -value $ComputerName
Set-ItemProperty -path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" -name "DefaultDomainName" -value $ComputerName

$MaxSize = (Get-PartitionSupportedSize -DriveLetter C).sizeMax
Resize-Partition -DriveLetter C -Size $MaxSize

Install-WindowsFeature RSAT-ADDS

# set DNS servers to AD servers so we can find FSx DNS entries
$serverAddresses = Get-DNSClientServerAddress -InterfaceAlias Ether* -AddressFamily IPv4
$ad_dns_ip_1="${ad_dns_ip_1}"
$ad_dns_ip_2="${ad_dns_ip_2}"
Set-DNSClientServerAddress -interfaceIndex $serverAddresses.InterfaceIndex -ServerAddresses ("$ad_dns_ip_1", "$ad_dns_ip_2")

# Windows 2016 Allows global mapping as 
# see https://medium.com/@bberkayilmaz/mounting-aws-fsx-with-autoscaling-in-terraform-eee3d115d49c - scenario 3
$secpasswd = ConvertTo-SecureString ${ad_admin_user_password} -AsPlainText -Force
$domaincreds = New-Object System.Management.Automation.PSCredential ("${ad_domain_name}\${ad_admin_user_name}", $secpasswd)
New-SmbGlobalMapping -RemotePath "\\${bfs_filesystem_dns_name}\share" -Credential $domaincreds -LocalPath Z:


</powershell>
<persist>true</persist>


